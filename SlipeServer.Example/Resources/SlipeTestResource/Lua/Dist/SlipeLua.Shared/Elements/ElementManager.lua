-- Generated by CSharp.lua Compiler
local System = System
local SlipeLuaMtaDefinitions = SlipeLua.MtaDefinitions
local SystemReflection = System.Reflection
local DictStringType = System.Dictionary(System.String, System.Type)
local DictTypeString = System.Dictionary(System.Type, System.String)
local SlipeLuaSharedElements
local DictObjectElement
System.import(function (out)
  SlipeLuaSharedElements = SlipeLua.Shared.Elements
  DictObjectElement = System.Dictionary(System.Object, SlipeLuaSharedElements.Element)
end)
System.namespace("SlipeLua.Shared.Elements", function (namespace)
  --/ <summary>
  --/ Class that manages MTAElement functionality and 
  --/ </summary>
  namespace.class("ElementManager", function (namespace)
    local instance, getInstance, getRoot, RegisterElement, GetElement, GetElement1, CastArray, GetTypeName, 
    GetByType, GetByType1, AddEventHandler, HandleEvent, class, __ctor__
    __ctor__ = function (this)
      this.elements = DictObjectElement()
      this.defaultElementTypes = DictStringType()
      this.defaultElementTypeNames = DictTypeString()

      local defaultClasses = SystemReflection.Assembly.GetAssembly(System.typeof(class)):GetExportedTypes()
      for _, type in System.each(defaultClasses) do
        local customAttributes = type:GetCustomAttributes(System.typeof(SlipeLuaSharedElements.DefaultElementClassAttribute), false)
        for _, a in System.each(customAttributes) do
          local attribute = System.cast(SlipeLuaSharedElements.DefaultElementClassAttribute, a)
          this.defaultElementTypes:set(attribute:getElementType(), type)
          this.defaultElementTypeNames:set(type, attribute:getElementType())
        end
      end
    end
    getInstance = function ()
      instance = instance or class()
      return instance
    end
    getRoot = function (this)
      if this.root == nil then
        this.root = GetElement1(this, SlipeLuaMtaDefinitions.MtaShared.GetRootElement())
      end
      return this.root
    end
    RegisterElement = function (this, element)
      this.elements:set(element:getMTAElement(), element)

      element:addOnDestroy(function (source, args)
        this.elements:RemoveKey(source:getMTAElement())
      end)
    end
    GetElement = function (this, element, T)
      if element == nil then
        return nil
      end
      if not SlipeLuaMtaDefinitions.MtaShared.IsElement(element) then
        return nil
      end
      if not this.elements:ContainsKey(element) then
        local mtaElementType = SlipeLuaMtaDefinitions.MtaShared.GetElementType(element)
        local elementType
        System.try(function ()
          elementType = this.defaultElementTypes:get(mtaElementType)
        end, function (default)
          if System.is(default, System.KeyNotFoundException) then
            elementType = System.typeof(SlipeLuaSharedElements.Element)
          else
            return 1, default
          end
        end)
        local default, extern = System.try(function ()
          local instance = System.Activator.CreateInstance(elementType, element)
          return true, System.cast(T, instance)
        end, function (default)
          return true, nil
        end)
        if default then
          return extern
        end
      end
      return System.cast(T, this.elements:get(element))
    end
    GetElement1 = function (this, element)
      return GetElement(this, element, SlipeLuaSharedElements.Element)
    end
    CastArray = function (this, elements, T)
      local result = System.Array(T)(#elements)
      for i = 0, #elements - 1 do
        result:set(i, GetElement(getInstance(), elements:get(i), T))
      end
      return result
    end
    GetTypeName = function (this, type)
      return this.defaultElementTypeNames:get(type)
    end
    GetByType = function (this, startAt, streamedIn, T)
      local elements = System.List(T)()

      if not this.defaultElementTypeNames:ContainsKey(System.typeof(T)) then
        return elements
      end

      local default = startAt
      if default ~= nil then
        default = default:getMTAElement()
      end
      local mtaElements = SlipeLuaMtaDefinitions.MtaShared.GetListFromTable(SlipeLuaMtaDefinitions.MtaClient.GetElementsByType(this.defaultElementTypeNames:get(System.typeof(T)), default, streamedIn), "element")
      for _, mtaElement in System.each(mtaElements) do
        local element = GetElement(this, mtaElement, T)
        if element ~= nil then
          elements:Add(element)
        end
      end

      return elements
    end
    GetByType1 = function (this, T)
      return GetByType(this, getRoot(this), false, T)
    end
    AddEventHandler = function (this, element, eventName, propagated, priorty)
      SlipeLuaMtaDefinitions.MtaShared.AddEventHandler(eventName, element:getMTAElement(), "Slipe.Shared.Elements.ElementManager.HandleEvent", propagated, priorty)
    end
    HandleEvent = function (eventString, source, p1, p2, p3, p4, p5, p6, p7, p8)
      SlipeLuaSharedElements.Element.getRoot():HandleEvent(eventString, source, p1, p2, p3, p4, p5, p6, p7, p8)
    end
    class = {
      getInstance = getInstance,
      getRoot = getRoot,
      RegisterElement = RegisterElement,
      GetElement = GetElement,
      GetElement1 = GetElement1,
      CastArray = CastArray,
      GetTypeName = GetTypeName,
      GetByType = GetByType,
      GetByType1 = GetByType1,
      AddEventHandler = AddEventHandler,
      HandleEvent = HandleEvent,
      __ctor__ = __ctor__,
      __metadata__ = function (out)
        return {
          fields = {
            { "defaultElementTypeNames", 0x1, System.Dictionary(System.Type, System.String) },
            { "defaultElementTypes", 0x1, System.Dictionary(System.String, System.Type) },
            { "elements", 0x1, System.Dictionary(System.Object, out.SlipeLua.Shared.Elements.Element) },
            { "instance", 0x9, class },
            { "root", 0x1, out.SlipeLua.Shared.Elements.Element }
          },
          properties = {
            { "Instance", 0x20E, class, getInstance },
            { "Root", 0x206, out.SlipeLua.Shared.Elements.Element, getRoot }
          },
          methods = {
            { ".ctor", 0x6, nil },
            { "AddEventHandler", 0x405, AddEventHandler, out.SlipeLua.Shared.Elements.Element, System.String, System.Boolean, System.String },
            { "CastArray", 0x10186, CastArray, function (T) return System.Array(out.SlipeLua.MtaDefinitions.MtaElement), System.Array(T) end },
            { "GetByType", 0x10286, GetByType, function (T) return out.SlipeLua.Shared.Elements.Element, System.Boolean, System.List(T) end },
            { "GetByType", 0x10086, GetByType1, function (T) return System.List(T) end },
            { "GetElement", 0x10186, GetElement, function (T) return out.SlipeLua.MtaDefinitions.MtaElement, T end },
            { "GetElement", 0x186, GetElement1, out.SlipeLua.MtaDefinitions.MtaElement, out.SlipeLua.Shared.Elements.Element },
            { "GetTypeName", 0x186, GetTypeName, System.Type, System.String },
            { "HandleEvent", 0xA0E, HandleEvent, System.String, out.SlipeLua.MtaDefinitions.MtaElement, System.Object, System.Object, System.Object, System.Object, System.Object, System.Object, System.Object, System.Object },
            { "RegisterElement", 0x106, RegisterElement, out.SlipeLua.Shared.Elements.Element }
          },
          class = { 0x6 }
        }
      end
    }
    return class
  end)
end)
